<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IoTa Device Manager | {{ title }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.6/css/dataTables.dataTables.css" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.1.6/css/dataTables.bootstrap5.min.css">

    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.6/js/dataTables.js"></script>
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/2.1.6/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/select/1.4.0/js/dataTables.select.min.js"></script>

    <style>
        .navbar,
        .navbar-brand,
        .navbar-nav a {
            background: #063f5c;
            color: #ffffff;
        }

        .navbar-nav a.nav-link.active {
            color: #fd7e14;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <header>
            <nav class="navbar navbar-expand-lg">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">IoTa Device Management Platform</span>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                        aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                        <div class="navbar-nav">
                            <a class="nav-link" href="/iota/physical-devices">Physical Devices</a>
                            <a class="nav-link active" href="/iota/logical-devices">Logical Devices</a>
                            <a class="nav-link" href="/iota/wombats">Wombats</a>
                            <a class="nav-link" href="/iota/map" target="_blank">Map</a>
                            <a class="nav-link" href="/iota/account">Account</a>
                            <a class="nav-link" href="/iota/signout">Signout</a>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <style>
            #export-data {
                min-height: 250px;
            }

            .bottom-right-div {
                position: absolute;
                bottom: 16px;
                right: 16px;
                width: 100%;
                text-align: right;
            }

            #loading-spinner {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                /* semi-transparent background */
                z-index: 9999;
                /* high z-index to ensure it's on top */
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }
        </style>

        <script type="text/javascript">
            let dialog = null;

            async function doFetch(event) {
                console.log($("#start_ts").val());
                console.log($("#end_ts").val());
                console.log(dialog.returnValue);

                if ('Export'.localeCompare(dialog.returnValue) === 0) {
                    try {
                        showSpinner();

                        console.log('Exporting data');
                        const formElement = document.getElementById('single-ld-export');
                        const formData = new FormData(formElement);
                        console.log(formData);
                        x = fetch(formElement.action, {
                            method: 'POST',
                            body: formData
                        })
                            .then(async response => {
                                if (response.status == 204) {
                                    alert('No messages found in selected date range.');
                                    return;
                                }

                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                const blob = await response.blob();
                                const filename = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/['"]/g, '') || 'download.csv';

                                // Check if the showSaveFilePicker API is available
                                if ('showSaveFilePicker' in window) {
                                    try {
                                        const handle = await window.showSaveFilePicker({
                                            suggestedName: filename,
                                            types: [{
                                                description: 'CSV File',
                                                accept: { 'text/csv': ['.csv'] },
                                            }],
                                        });
                                        const writable = await handle.createWritable();
                                        await writable.write(blob);
                                        await writable.close();
                                    } catch (err) {
                                        if (err.name !== 'AbortError') {
                                            console.error('Failed to save file:', err);
                                            // Fallback to the older method
                                            saveBlobAsFile(blob, filename);
                                        }
                                    }
                                } else {
                                    // Fallback for browsers that don't support showSaveFilePicker
                                    saveBlobAsFile(blob, filename);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert("Error occured on submission", error);
                            });

                        // Wait for the fetch to finish so the spinner shows up.
                        await x;
                    } finally {
                        hideSpinner();
                    }
                }
            }

            $(document).ready(function () {
                $('.data-table').DataTable();

                dialog = document.getElementById('export-data');
                // A submit handler would avoid this getting called when the dialog is dismissed using
                // the escape key, but it does not get the correct value for dialog.returnValue.
                //
                // The close handler gets called all the time but at least dialog.returnValue has a
                // valid value.
                dialog.addEventListener("close", doFetch);
            });

            function exportData(l_uid) {
                dialog.returnValue = "Cancel";
                dialog.showModal();
            }

            function saveBlobAsFile(blob, filename) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }

            function showSpinner() {
                console.log('showing spinner');
                document.getElementById('loading-spinner').style.display = 'flex';
            }

            function hideSpinner() {
                console.log('hiding spinner');
                document.getElementById('loading-spinner').style.display = 'none';
            }

        </script>

        <!-- Are the nested divs necessary or is the inner one sufficient? -->
        <div id="loading-spinner" style="display: none;">
            <div class="spinner"></div>
        </div>

        <dialog id="export-data">
            <header>
                <h3 style="padding: 8px">Export data</h3>
            </header>
            <form id="single-ld-export" action="{{ url_for('DownloadData') }}" method="dialog">
                <div>
                    <p style="margin-top: 32px">Data will be exported from the beginning of 'From' until the end of
                        'To'.</p>
                </div>
                <div>
                    <table>
                        <tr>
                            <td>From</td>
                            <td>To</td>
                        </tr>
                        <tr>
                            <td><input type="date" id="start_ts" name="start_ts" /></td>
                            <td><input type="date" id="end_ts" name="end_ts" /></td>
                        </tr>
                    </table>
                </div>
                <input type="hidden" name="l_uid" value="{{ ld_data.uid }}" />
                <div class="bottom-right-div">
                    <input type="submit" value="Cancel" />
                    <input type="submit" value="Export" />
                </div>
            </form>
        </dialog>

        <div class="px-4 pt-0 mt-0 mb-6" style="background-color: antiquewhite;">
            <h2 class="form-heading pt-3">{{ title }}</h2>
            <div class="row justify-content-between">
                <div class="col small">
                    Last seen: {{ deviceLastSeen }}
                </div>
                {% if ubidots_link != "" %}
                <div class="col">
                    <a style="float: inline-end;" href="{{ ubidots_link }}" target="_blank">Ubidots</a>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-4">
            <div class="col">
                <div class="card text-bg-light">
                    <div class="card-header row mx-0">
                        <div class="col-9 h4">Device Properties</div>
                        <div class="col-2">

                            <button type="button" class="btn btn-sm btn-outline-primary" style="float: inline-end;"
                                onclick="exportData('{{ ld_data.uid }}')">Export Data</button>
                        </div>

                        <div class="col-1">
                            <button type="button" class="btn btn-sm btn-outline-primary">Save</button>
                        </div>
                    </div>

                    <div class="card-body">
                        <form id="device-form" action="{{ url_for('UpdateLogicalDevice') }}" target="hidden-frame">

                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label" for="form-name">Name</label>
                                <div class="col-sm-6">
                                    <input type="text" id="form-device-name" class="form-control" name="form_name"
                                        value="{{ ld_data.name }}">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label id="form-location-label" class="col-sm-2 col-form-label"
                                    for="form-name">Location</label>
                                <div class="col-sm-6">
                                    <input type="text" id="form-location" class="form-control" name="form_location"
                                        value="{{ deviceLocation }}">
                                </div>
                            </div>
                            <label class="form-label" for="dev-props">Properties</label>
                            <textarea class="form-control" id="dev-props" name="props" rows="25"
                                style="font-size: smaller; font-family: Consolas, Monaco, 'Courier New', monospace;">
								{{ properties }}
							</textarea>
                        </form>

                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-bg-light mb-3">
                    <div class="card-header row mx-0">
                        <div class="col-11 h4">Mappings</div>
                        <div class="col-1"><button type="button" class="btn btn-sm btn-outline-primary">New</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped data-table" data-searching='false' data-ordering='false'>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Active</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% for mapping in deviceMappings %}
                                <tr>
                                    <td>{{ mapping.pd.uid }}</td>
                                    <td><a href="{{ url_for('physical_device_form', uid=mapping.pd.uid) }}">{{
                                            mapping.pd.name }}</a></td>
                                    <td>{{ mapping.start_time }}</td>
                                    {% if mapping.end_time is none() %}
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                            onclick="handleEndMapping('{{ ld_data.uid }}', 'LD')">End
                                            Mapping</button>
                                    </td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="flexSwitchCheckChecked"
                                                onclick="handleToggleMapping('{{ mapping.pd.uid }}','{{ mapping.is_active }}', 'PD')"
                                                {% if mapping.is_active %}checked{% endif %}>
                                        </div>
                                    </td>
                                    {% else %}
                                    <td>
                                        {{ mapping.end_time }}
                                    </td>
                                    <td>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>

</html>