{% extends "base.html" %}
{% block content %}

<style>
    #export-data {
        min-height: 250px;
    }

    .bottom-right-div {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 100%;
        text-align: right;
    }

    #loading-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        /* semi-transparent background */
        z-index: 9999;
        /* high z-index to ensure it's on top */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script type="text/javascript">
    /*
                document.addEventListener('DOMContentLoaded', function () {
                    const form = document.getElementById('device-form');
                    const textarea = document.getElementById('dev-props');
    
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();
    
                        let isValid = true;
                        let err_msg = "";
                        try {
                            JSON.parse(textarea.value);
                        } catch (error) {
                            isValid = false;
                            err_msg = error.message;
                        }
    
                        if (isValid) {
                            console.log('Form is valid, ready to submit');
                            const formData = new FormData(form);
    
                            fetch(form.action, {
                                method: 'PATCH',
                                body: formData
                            })
                                .then(data => {
                                    //Handle success, e.g., reload the page
                                    window.location.reload(true);
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert("Error occured on submission", error)
                                });
    
                        } else {
                            alert(`Invalid JSON in properties:\n${err_msg}`);
                        }
                    });
                });
    */
    let dialog = null;

    async function doFetch(event) {
        console.log($("#start_ts").val());
        console.log($("#end_ts").val());
        console.log(dialog.returnValue);

        if ('Export'.localeCompare(dialog.returnValue) === 0) {
            try {
                showSpinner();

                console.log('Exporting data');
                const formElement = document.getElementById('single-ld-export');
                const formData = new FormData(formElement);
                console.log(formData);
                x = fetch(formElement.action, {
                    method: 'POST',
                    body: formData
                })
                    .then(async response => {
                        if (response.status == 204) {
                            alert('No messages found in selected date range.');
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        const blob = await response.blob();
                        const filename = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/['"]/g, '') || 'download.csv';

                        // Check if the showSaveFilePicker API is available
                        if ('showSaveFilePicker' in window) {
                            try {
                                const handle = await window.showSaveFilePicker({
                                    suggestedName: filename,
                                    types: [{
                                        description: 'CSV File',
                                        accept: { 'text/csv': ['.csv'] },
                                    }],
                                });
                                const writable = await handle.createWritable();
                                await writable.write(blob);
                                await writable.close();
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Failed to save file:', err);
                                    // Fallback to the older method
                                    saveBlobAsFile(blob, filename);
                                }
                            }
                        } else {
                            // Fallback for browsers that don't support showSaveFilePicker
                            saveBlobAsFile(blob, filename);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("Error occured on submission", error);
                    });

                // Wait for the fetch to finish so the spinner shows up.
                await x;
            } finally {
                hideSpinner();
            }
        }
    }

    // Comes from base.html
    $(document).ready(function () {
        $('.data-table').DataTable();

        dialog = document.getElementById('export-data');
        // A submit handler would avoid this getting called when the dialog is dismissed using
        // the escape key, but it does not get the correct value for dialog.returnValue.
        //
        // The close handler gets called all the time but at least dialog.returnValue has a
        dialog.addEventListener("close", doFetch);
    });

    window.addEventListener("DOMContentLoaded", (event) => {
        document.body.addEventListener('htmx:afterSwap', event => {
            // Refresh the datatable - if this isn't done the HTML table shows up
            // but there are no DataTable decorations around it.
            if (event.target.id == 'dev-mapping-card') {
                let table = $('#mapping_table').DataTable();
                table.draw('full-reset');
            }
        });
    });

    function exportData(l_uid) {
        dialog.returnValue = "Cancel";
        dialog.showModal();
    }

    function saveBlobAsFile(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function showSpinner() {
        console.log('showing spinner');
        document.getElementById('loading-spinner').style.display = 'flex';
    }

    function hideSpinner() {
        console.log('hiding spinner');
        document.getElementById('loading-spinner').style.display = 'none';
    }

</script>

<!-- Are the nested divs necessary or is the inner one sufficient? -->
<div id="loading-spinner" style="display: none;">
    <div class="spinner"></div>
</div>

<dialog id="export-data">
    <header>
        <h3 style="padding: 8px">Export data</h3>
    </header>
    <form id="single-ld-export" action="{{ url_for('DownloadData') }}" method="dialog">
        <div>
            <p style="margin-top: 32px">Data will be exported from the beginning of 'From' until the end of
                'To'.</p>
        </div>
        <div>
            <table>
                <tr>
                    <td>From</td>
                    <td>To</td>
                </tr>
                <tr>
                    <td><input type="date" id="start_ts" name="start_ts" /></td>
                    <td><input type="date" id="end_ts" name="end_ts" /></td>
                </tr>
            </table>
        </div>
        <input type="hidden" name="l_uid" value="{{ dev.uid }}" />
        <div class="bottom-right-div">
            <input type="submit" value="Cancel" />
            <input type="submit" value="Export" />
        </div>
    </form>
</dialog>

<div class="px-4 pt-0 mt-0 mb-6" id="dev-hdr">
    <h2 class="form-heading pt-3" id="dev-name-title">{{ title }}</h2>
    <div class="row justify-content-between">
        <div class="col small" id="dev-last-seen">
            Last seen: {{ deviceLastSeen }}
        </div>
        {% if ubidots_link != "" %}
        <div class="col">
            <a style="float: inline-end;" href="{{ ubidots_link }}" target="_blank">Ubidots</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col">
        {% include 'device_card.html' %}
    </div>
    <div class="col">
        {% include 'dev_mapping_card.html' %}
    </div>
</div>
{% endblock %}